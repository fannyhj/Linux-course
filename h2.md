# H2 - Infraa koodina

## Tiivistelmä - (https://terokarvinen.com/2024/hello-salt-infra-as-code/)

- Asennetaan Salt, jos ei ole jo.
- Käytetään/ladataan 'micro editori'.
- Luodaan kansio "hello" moduulille. /srv/salt/hello kansio jaetaan kaikille orjakoneille.
- Siirrytään kansioon ja avataan micro editori.
- Kirjoitetaan koodia.
- Ajetaan koodi.

## Tiivistelmä - (https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#rules-of-yaml)

Rules of YAML:
- Data muodostuu "Key: value" pareista.
- Mapitukset käyttää kaksoispistettä ja välilyöntiä merkitäkseen paritukset.
- Kaikki nämä ovat tapauskohtaisia.
- Tabulaattoria ei saa käyttää, vain välilyöntejä.
- Kommentit alkavat # merkillä.

  
YAML simple structure:
- YAML muodostuu kolmesta perus elementtityypistä:
- 1. Skalaareissa arvo voi olla numero, merkkijono tai totuusarvo.
- 2. Listoissa "key":tä seuraa lista arvoja, jossa jokainen arvo on erillisellä rivillä ja joita seuraa kaksi välilyöntiä ja väliviiva.
- 3. Sanakirjat on kokoelma mapituksia ja listoja.
 
Lists and dictionaries - YAML block structures
- YAML on järjestetty lohkorakenteisiin.
- Sisennys asettaa kontekstin. Käyttäjän täytyy sisennettävä ominaisuudet ja lista yhdellä tai useammalla väliyönnillä, mutta kaksi välilyöntiä on vakio.
- Kokoelma, joka on luettelo tai sanakirja lohkosarja osoittaa jokaisen merkinnän yhdysmerkillä ja välilyönnillä.

## Tiivistelmä - (https://docs.saltproject.io/en/latest/ref/states/top.html)

Introduction:
- Suurin osa infrastrukuureisa koostuvat ryhmittyneistä koneista, jossa jokaisella koneella on saallainen rooli toisiin.
- Ryhmien hallinnan edellytyksenä administraattorin täytyy luoda roolit ryhmille.
- Saltissa tiedostoa, joka sisältää verkossa olevien koneryhmien välisen mapituksen sekä niihin sovellettavat konfiguraatio roolit, kutsutaan "top fileksi".
- Top filet ovat automaattisesti nimetty "top.sls":ksi, koska ne ovat aina tiedostojen hierarkkiassa päällimmäisenä.

A basic example:
- Top filet sisältävät kolmme komponenttia:
- 1. Ympäristö: Tilapuuhakemisto, joka sisältää joukon tilatiedostoja järjestelmien konfigurointia varten.
- 2. Kohde: Ryhmä koneita, joille asetetaan joukko tiloja.
- 3. Tilatiedostot: Luettelo tilatiedostoista, joita sovelletaan kohteeseen. Jokainen tilatiedosto kuvaa yhden tai useamman tilan, jotka konfiguroidaan ja laitetaan täytäntöön kohdekoneissa.
- Ympäristöt sisältävät kohteita ja kohteet sisältävät tiloja.

Käytin ensimmäiseen harjoitukseen apuna Tero Karvisen ohjetta "Hello Salt Infra-as-Code". Aloitin päivittämällä virtuaalikoneeni komennolla 'sudo apt-get update'. Tämän jälkeen latasin micro-editorin komennolla 'sudo apt-get -y install micro' ja sitten 'export EDITOR=micro'. (Karvinen 2024)

<img width="805" height="463" alt="image" src="https://github.com/user-attachments/assets/668579aa-de97-4722-b855-e2aaf99bc5c8" />
<img width="748" height="83" alt="image" src="https://github.com/user-attachments/assets/f2555ef5-dc57-439e-9660-28edbe4484c4" />


Loin tämän jälkeen kansion komennolla 'sudo mkdir -p /srv/salt/hello/'. Siirryin sitten kansioon komennolla 'cd /srv/salt/hello'. Muokkasin sitten tiedostoa init.sls, siirtymällä sinne komennolla 'sudoedit init.sls'. Kirjoitin tiedostoon sitten '/tmp/hellotero: file.managed'. (Karvinen 2024)

<img width="453" height="76" alt="image" src="https://github.com/user-attachments/assets/d9d6f598-d446-4d5d-864c-a52261279ea1" />


Ajoin tämän jälkeen komennon 'sudo salt-call --local state.apply hello'. 

<img width="1011" height="484" alt="image" src="https://github.com/user-attachments/assets/cdf94c93-f538-488c-a4da-938466be6687" />


Tein sitten top.sls tiedoston käyttäen Salt Projecin ohjeita "The.top.file". Käytin komentoa 'sudo nano /srv/salt/top.sls' ja kirjoitin sisältöön seuraavan:

base:

  '*':
  
    - example
    
Top filen avulla 'sudo salt-call --local state.apply' ajaa kaikki sinne kirjoitetut tiedostot samanaikaisesti.

<img width="760" height="122" alt="image" src="https://github.com/user-attachments/assets/8297c91f-6919-4e5e-8f5e-e561f55627c2" />


Tein sitten tiedoston hellofile/hello.sls käyttäen apuna Salt Projectin ohjetta "Salt.states.file". Käytin ensimmäiseksi komentoa 'sudo nano /srv/salt/hellofile/init.sls ja lisäsin sisältöön seuraavan:

/tmp/hello_file.txt:
  file.managed:
  
    - contents: |
    
      Tämä tiedosto luotiin Saltin avulla.
      
    - mode: 644
    
    - user: root
    
    - group: root
(Salt Project, 2025)

Testasin toimivuuden komennolla 'sudo salt-call --local state.apply hellofile' sekä 'cat /tmp/hello_file.txt¨'. 

<img width="1046" height="537" alt="image" src="https://github.com/user-attachments/assets/5c14df35-fca0-470e-b297-19e578a6f509" />

<img width="842" height="64" alt="image" src="https://github.com/user-attachments/assets/77ba984c-70aa-4d0c-98c2-f3f55b39bab6" />     


Sitten tein tiedoston palvelun hallintaan komennolla 'sudo nano /srv/salt/helloservice/init.sls' ja lisäsin sisältöön seuraavan:

ssh_service:

  service.running:
  
    - name: ssh
    
    - enable: True
    
Testasin toimivuuden komennolla 'sudo salt-call --local state.apply helloservice'. Tuloksena sain epäonnistuneen ilmoituksen, koska minulla ei ollut SSH:ta asennettuna. Latasin SSH:n komennolla 'sudo apt install openssh-server -y' ja ajoin local komennon uudestaan ja sain onnistuneen ilmoituksen.

<img width="1050" height="487" alt="image" src="https://github.com/user-attachments/assets/ffb4d541-09ba-4f7d-96ef-2d63131c469a" />

<img width="859" height="383" alt="image" src="https://github.com/user-attachments/assets/2d43c9e6-5433-4ff0-a088-d528c2562a77" />

Tein sitten Salt Projectin ohjeilla "Salt.states.pkg" pakettien hallintaa. Tein taas tiedoston komennolla 'sudo nano /srv/salt/hellopkg/init.sls' ja lisäsin sisältöön seuraavan:

install_nginx:

  pkg_installed:
  
    - name: nginx
    
    - creates:
    
      - /etc/nginx.conf

(Salt Project, 2025)
      
Testasin toimivuuden jälleen komennolla 'sudo salt-call --local state.apply hellopkg'.

<img width="969" height="603" alt="image" src="https://github.com/user-attachments/assets/9b05a133-cbba-4a23-bbc9-5de9c5470bb0" />


Tein tämän jälkeen käyttäjien hallintaa käyttäen apuna jälleen Salt Servicen ohjetta "Salt.states.user". Tein tiedoston tutulla 'sudo nano /srv/salt/hellouser/init.sls' komennolla ja lisäsin sisältöön seuraavan:

create_hellouser

  user.present:
  
    - name: hellouser
    
    - home: /home/hellouser
    
    - shell: /bin/bash
    
Testasin toimivuuden komennolla 'sudo salt-call --local state.apply hellouser'.

<img width="542" height="709" alt="image" src="https://github.com/user-attachments/assets/f9719378-c4e5-45dd-bf3a-2553c811ef4b" />

Viimeisenä kokeilin komennon suoritusta käyttäen Salt Servicen ohjetta "Salt.states.cmd". Aloitin komennolla 'sudo nano /srv/salt/hellocmd/init.sls' ja kirjoitoin sisältöön:

run_echo_command:

  cmd.run:
  
    - name: echo "Hei Salt!" > /tmp/hello_salt_cmd.txt
    
    - creates: /tmp/hello_salt_cmd.txt
    
Testasin toimivuuden komennolla 'sudo salt-call --local state.apply hellocmd', ja cat '/tmp/hello_salt_cmd.txt'.

<img width="921" height="600" alt="image" src="https://github.com/user-attachments/assets/b94cc2c5-1a19-4c9d-a345-d979827bf58e" />

Tämän jälkeen yhdistin file ja pkg tilafunktiot sls-tiedostoon komennolla 'sudo nano /srv/salt/esimerkkikaksi/init.sls'. Lisäsin sisältöön seuraavan:

install_vim:

  pkg.installed:
  
    - name: vim

/tmp/esimerkki_kaksi.txt:

  file.managed:
  
    - mode: 644
    
    - user: root
    
    - group: root
    
    - require:
    
      - pkg: install_vim
      
Testasin jälleen komennolla 'sudo salt-call --local state.apply esimerkkikaksi'.

<img width="828" height="704" alt="image" src="https://github.com/user-attachments/assets/a125bada-2fe3-430c-b337-5cfdae78d952" />

Viimeisenä osana harjoitusta lisäsin kaikki tekemäni tiedostot top fileen, että saan kaikki ajettua samanaikaisesti local komennolla.

<img width="1013" height="690" alt="image" src="https://github.com/user-attachments/assets/846395df-e684-4bfd-b5f1-10f1a39f3796" />


## Lähteet:
Karvinen, Tero 2024: Hello Salt Infra-as-Code. Luettavissa: https://terokarvinen.com/2024/hello-salt-infra-as-code/
Salt Project, 2025: The top file. Luettavissa: https://docs.saltproject.io/en/latest/ref/states/top.html
Salt Project, 2025: Salt.states.file. Luettavissa: https://docs.saltproject.io/en/latest/ref/states/all/salt.states.file.html
Salt Project, 2025: Salt.states.service. Luettavissa: https://docs.saltproject.io/en/latest/ref/states/all/salt.states.service.html
Salt Project, 2025: Salt.states.pkg. Luettavissa: https://docs.saltproject.io/en/3006/ref/states/all/salt.states.pkg.html
Salt Project, 2025: Salt.states.user. Luettavissa: https://docs.saltproject.io/en/3006/ref/states/all/salt.states.user.html
Salt Project, 2025: Salt.states.cmd. Luettavissa: https://docs.saltproject.io/en/3007/ref/states/all/salt.states.cmd.html













