## Tiivistelmä - Tero Karvinen: Pkg-File-Service – Control Daemons with Salt – Change SSH Server Port (https://terokarvinen.com/2018/04/03/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/?fromSearch=karvinen%20salt%20ssh)

- Voit hallita valtavia määriä daemoneja konfiguraationhallintajärjestelmällä. Package-file-service on yleinen malli tähän.
- Periaate on: asenna ohjelmisto, vaihda määritystiedosto ja käynnistä daemon uudelleen uuden kokoonpanon käyttämiseksi.
- Luo SSH state
- Sovella state orjille
- Testaa

## h4 Pkg-file-service

Ensimmäisenä tarkistin ssh:n komennolla 'sudo ss -tlnp | grep ssh'.

<img width="814" height="129" alt="image" src="https://github.com/user-attachments/assets/a346c06e-cda3-4d5b-950c-1c29434fddea" />

Kuvassa näkyy, että SSHD kuuntelee vain porttia 22. 0.0.0.0:22 → IPv4:ssä portti 22 auki kaikille osoitteille. [::]:22 → IPv6:ssä portti 22 auki kaikille osoitteille


Tämän jälkeen muuokkasin sshd_configia komennolla 'sudoedit /etc/ssh/sshd_config' lisäämällä portin 22 ja päätin valita toiseksi portiksi 2222.

<img width="828" height="468" alt="image" src="https://github.com/user-attachments/assets/cb40cb0b-fdfd-4b9b-b501-450eaceb2615" />


Käynnnistin ssh:n uudelleen komennolla 'sudo systemctl restart ssh' ja sitten syötin saman komennon kuin aikaisemmin (sudo ss -tlnp | grep ssh) ja näin, että SSHD kuuntelee nyt myös porttia 2222.

<img width="805" height="177" alt="image" src="https://github.com/user-attachments/assets/b1f94efb-1a43-4942-8486-1aa8346a6b85" />


Seuraavaksi päivitin koneeni komennolla 'sudo apt-get update' ja sitten käynnistin latauksen komennolla 'sudo apt-get install -y openssh-server'.

<img width="778" height="142" alt="image" src="https://github.com/user-attachments/assets/e36c4eb2-cc00-4339-8d56-4a736fe7cf61" />


Kokeilin sitten komentoa 'nc -vz localhost 2222', mutta sain vastaukseksi "nc command not found". Jouduin siis lataamaan netcatin komennolla 'sudo apt-get install -y netcat-openbsd'.

<img width="799" height="379" alt="image" src="https://github.com/user-attachments/assets/eac7837b-ac27-4730-b704-08d7fc170e6d" />


Uusi yritys

<img width="657" height="61" alt="image" src="https://github.com/user-attachments/assets/1b1fa9bf-d1df-4488-b93f-32dbdafa23da" />

Onnistuu!


Seuraavaksi pyrin näyttämään, että tilani korjaa puutteet. Poistin siis openssh-serversin komennolla 'sudo apt-get remove --purge openssh-server'.

<img width="801" height="373" alt="image" src="https://github.com/user-attachments/assets/ab56f984-72b4-4040-81f5-6ebfe06afd36" />


Tämän jälkeen loin Saltin hallitseman asetustiedoston komennolla 'sudoedit /srv/salt/ssh/sshd_config'.

<img width="741" height="203" alt="image" src="https://github.com/user-attachments/assets/71bcda93-2241-4032-9d7c-1702d1a0c8ea" />


Muokkasin sitten init.sls tiedostoa lisäämällä muokatun version Tero Karvisen Pkg-File-Service ohjeissa näkyvästä tekstipätkästä. Siirryin tiedostoon komennolla 'sudoedit /srv/salt/ssh/init.sls'. (Tero Karvinen, 2018)

<img width="521" height="344" alt="image" src="https://github.com/user-attachments/assets/84909dc6-0a98-43da-b18b-61b84e8af781" />


Ajoin sitten paikallisesti komennon kirjoittamalla 'sudo salt-call --local state.apply ssh'.

<img width="770" height="471" alt="image" src="https://github.com/user-attachments/assets/5a2cce5a-058c-486b-8019-a7e0a0251e04" />


Tarkistin sitten, että asetukset ovat korjautuneet komennolla 'grep Port /etc/ssh/sshd_config'.

<img width="652" height="61" alt="image" src="https://github.com/user-attachments/assets/46eeeaa0-9911-44cd-8d20-da371caa2775" />


Viimeiseksi testasin toimivuuden porttitestillä käyttämällä komentoja 'nc -vz localhost 22' ja 'nc -vz localhost 2222'.

<img width="692" height="98" alt="image" src="https://github.com/user-attachments/assets/bdfc1577-8c0c-4463-bab1-e18fcf4e8b5f" />

# Lähteet:

Tero Karvinen, 2018. Pkg-File-Service – Control Daemons with Salt – Change SSH Server Port. Luettavissa: https://terokarvinen.com/2018/04/03/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/?fromSearch=karvinen%20salt%20ssh
Apuna käytetty myös ChatGPT:tä komentojen ehdottamiseen.

